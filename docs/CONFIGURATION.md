# Configuration Guide

**Version**: 1.9.0

Hydro-Map reads configuration from environment variables defined in `.env` (project root) using Pydantic settings. This guide summarizes the available knobs and how they tie back to the code base.

---

## 1. Server Basics

| Variable | Default | Purpose |
| --- | --- | --- |
| `BACKEND_HOST` | `0.0.0.0` | Bind address for the FastAPI server |
| `BACKEND_PORT` | `8000` | API port |
| `BACKEND_RELOAD` | `true` | Enable hot reload during development |

Production tip: set `BACKEND_RELOAD=false` and front your app with a process manager (gunicorn, uvicorn workers, or systemd) plus a reverse proxy.

---

## 2. Core Data Paths

All defaults are relative to `backend/`. Update them if you store data elsewhere.

| Variable | Default | Used by |
| --- | --- | --- |
| `DEM_PATH` | `../data/processed/dem/filled_dem.tif` | Watershed delineation & DEM sampling |
| `FLOW_DIR_PATH` | `../data/processed/dem/flow_direction.tif` | Watershed tracing |
| `FLOW_ACC_PATH` | `../data/processed/dem/flow_accumulation.tif` | Pour-point snapping |
| `GEOLOGY_PATH` | `../data/processed/geology.gpkg` | Feature Info geology lookups (optional) |
| `FAIRFAX_WATERSHEDS_PATH` | `../data/processed/fairfax_watersheds.gpkg` | Feature Info watershed attribution |

The backend logs the resolved paths during startup so you can confirm they point to the expected files.

---

## 3. Dataset Map for Feature Info

`Settings.LAYER_DATASET_MAP` maps frontend layer IDs to the GeoPackages queried by `/api/feature-info`. Defaults (from `backend/app/config.py`):

```python
LAYER_DATASET_MAP = {
    "geology": ("../data/processed/geology.gpkg", None),
    "fairfax-watersheds": ("../data/processed/fairfax_watersheds.gpkg", "fairfax_watersheds"),
    "fairfax-water-lines": ("../data/processed/fairfax_water_lines.gpkg", "fairfax_water_lines"),
    "fairfax-water-polys": ("../data/processed/fairfax_water_polys.gpkg", "fairfax_water_polys"),
    "inadequate-outfalls": ("../data/raw/fairfax/inadequate_outfalls.gpkg", "inadequate_outfalls")
}
```

- The tuple is `(path, layer_name)`; set `layer_name=None` for single-layer GeoPackages.
- The stormwater polygon query still points at the raw download path. If you want the normalized version generated by `prepare_fairfax_stormwater.py`, change the path to `../data/processed/inadequate_outfalls.gpkg`.
- Override the map by editing `config.py` or supplying a JSON string via the `LAYER_DATASET_MAP` environment variable (Pydantic will parse it automatically).

Add new datasets by extending this dictionary and wiring corresponding layers into the frontend configuration.

---

## 4. Watershed Delineation Controls

| Variable | Default | Description |
| --- | --- | --- |
| `SNAP_TO_STREAM` | `true` | Snap pour points to high flow-accumulation cells |
| `DEFAULT_SNAP_RADIUS` | `100` | Radius (meters) for snapping search window |
| `CACHE_ENABLED` | `true` | Cache delineation responses on disk |
| `CACHE_DIR` | `./data/cache` | Cache location (relative to `backend/`) |

Snapping runs against the flow accumulation raster—disable it if you only delineate at known outlets. Cached responses are stored as JSON under `CACHE_DIR/watersheds/`.

---

## 5. Cross-Section Sampling

| Variable | Default | Notes |
| --- | --- | --- |
| `CROSS_SECTION_SAMPLE_DISTANCE` | `10` | Sampling interval in meters |
| `CROSS_SECTION_MAX_POINTS` | `1000` | Hard ceiling on number of samples |

Adjust these based on DEM resolution. Higher intervals reduce response size at the expense of detail.

---

## 6. CORS & Redis

| Variable | Default | Usage |
| --- | --- | --- |
| `CORS_ORIGINS` | `["http://localhost:5173", "http://localhost:3000"]` | Comma-separated origins allowed to call the API |
| `REDIS_HOST` / `REDIS_PORT` / `REDIS_DB` | `localhost`, `6379`, `0` | Optional. Present for future Redis cache integration; unused unless you wire it up manually. |

In production, specify your public domains explicitly in `CORS_ORIGINS`.

---

## 7. PMTiles URLs

The backend exposes convenience URLs that the frontend can use if you deploy a static build:

| Variable | Default |
| --- | --- |
| `PUBLIC_HILLSHADE_URL` | `/tiles/hillshade.pmtiles` |
| `PUBLIC_SLOPE_URL` | `/tiles/slope.pmtiles` |
| `PUBLIC_ASPECT_URL` | `/tiles/aspect.pmtiles` |
| `PUBLIC_STREAMS_URL` | `/tiles/streams.pmtiles` |
| `PUBLIC_GEOLOGY_URL` | `/tiles/geology.pmtiles` |
| `PUBLIC_CONTOURS_URL` | `/tiles/contours.pmtiles` |

If you serve tiles from a CDN or different origin, update these values and mirror the same base path in the frontend configuration.

---

## 8. Frontend Configuration

The main knobs live in `frontend/src/lib/config/layers.ts`:

- `LAYER_SOURCES` defines every layer shown in the UI (id, label, PMTiles filename, paint style).
- Stormwater layers (`floodplain-easements`, `inadequate-outfalls`, `inadequate-outfall-points`) are hidden by default—set `defaultVisible=true` if you want them to load immediately.

Basemap control persists the selection (`vector`, `light`, or `none`) using the Svelte store `basemapStyle`. Provide a Stadia Maps key via `VITE_STADIA_API_KEY`.

---

## 9. Common Customizations

1. **Different project area**  
   - Update AOI bounding boxes inside `download_fairfax_*.py` or replace those scripts with equivalents for your region.  
   - Point `LAYER_DATASET_MAP` entries at your processed GeoPackages.  
   - Adjust the frontend layer metadata (names, colors) in `layers.ts`.

2. **Disable stormwater overlays**  
   - Remove or comment the relevant entries in `layers.ts`.  
   - Optionally delete the `generate_tiles.py` vector mappings so the script skips them.

3. **Change cache behaviour**  
   - Turn `CACHE_ENABLED` off if disk IO is a concern or the DEM is small enough that delineations are consistently fast.

4. **Publish static tiles**  
   - Serve `data/tiles/` from a CDN or object store and update the `PUBLIC_*` URLs plus the `PMTILES_BASE_URL` (if you introduce one) so the frontend fetches from the new host.

---

## 10. Verifying Configuration

1. Start the backend with `uvicorn app.main:app --reload` and watch the console output—it prints resolved paths and cache configuration.  
2. Call `curl http://localhost:8000/api/delineate/status` to confirm required rasters exist.  
3. When using Feature Info, inspect the API response to ensure dataset names and fields match your expectations.

Keep `.env` out of version control (already ignored) and commit configuration code changes separately from data updates.
